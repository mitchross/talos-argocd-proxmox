---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: volsync-pvc-backup-restore
  annotations:
    argocd.argoproj.io/sync-wave: "4"
    policies.kyverno.io/title: VolSync PVC Backup and Restore
    policies.kyverno.io/description: >-
      Automatically configures VolSync backup and restore for PVCs with the
      label backup: "hourly" or backup: "daily". Checks S3 for existing backup
      via pvc-plumber and conditionally enables restore via VolumePopulator.
spec:
  mutateExistingOnPolicyUpdate: false
  background: true
  rules:
    # Rule 1: Conditionally add dataSourceRef if backup exists in S3
    # IMPORTANT: Only trigger on CREATE to avoid race conditions during PVC deletion
    - name: add-datasource-if-backup-exists
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              operations:
                - CREATE
              selector:
                matchExpressions:
                  - key: backup
                    operator: In
                    values: ["hourly", "daily"]
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - volsync-system
                - kyverno
      context:
        - name: backupCheck
          apiCall:
            method: GET
            service:
              url: "http://pvc-plumber.volsync-system.svc.cluster.local/exists/{{request.object.metadata.namespace}}/{{request.object.metadata.name}}"
      preconditions:
        all:
          - key: "{{ backupCheck.exists || false }}"
            operator: Equals
            value: true
          - key: "{{ request.object.spec.dataSourceRef || '' }}"
            operator: Equals
            value: ""
      mutate:
        patchStrategicMerge:
          spec:
            dataSourceRef:
              apiGroup: volsync.backube
              kind: ReplicationDestination
              name: "{{request.object.metadata.name}}-restore"

    # Rule 2: Generate ExternalSecret for per-PVC restic repository
    # IMPORTANT: Only trigger on CREATE to avoid race conditions during PVC deletion
    - name: generate-restic-secret
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              operations:
                - CREATE
              selector:
                matchExpressions:
                  - key: backup
                    operator: In
                    values: ["hourly", "daily"]
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - volsync-system
                - kyverno
      generate:
        synchronize: true
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        name: "volsync-{{request.object.metadata.name}}"
        namespace: "{{request.object.metadata.namespace}}"
        data:
          metadata:
            labels:
              app.kubernetes.io/managed-by: kyverno
              volsync.backup/pvc: "{{request.object.metadata.name}}"
          spec:
            refreshInterval: 1h
            secretStoreRef:
              kind: ClusterSecretStore
              name: 1password
            target:
              name: "volsync-{{request.object.metadata.name}}"
              creationPolicy: Owner
              template:
                engineVersion: v2
                metadata:
                  labels:
                    app.kubernetes.io/managed-by: kyverno
                    volsync.backup/pvc: "{{request.object.metadata.name}}"
                data:
                  RESTIC_REPOSITORY: "s3:http://192.168.10.133:30292/volsync-backup/{{request.object.metadata.namespace}}/{{request.object.metadata.name}}"
            data:
              - secretKey: AWS_ACCESS_KEY_ID
                remoteRef:
                  key: rustfs
                  property: k8s-admin-access-key
              - secretKey: AWS_SECRET_ACCESS_KEY
                remoteRef:
                  key: rustfs
                  property: k8s-admin-secret-key
              - secretKey: RESTIC_PASSWORD
                remoteRef:
                  key: rustfs
                  property: restic_password

    # Rule 3: Generate ReplicationSource (backup schedule)
    # IMPORTANT: Only trigger on CREATE to avoid race conditions during PVC deletion
    - name: generate-replication-source
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              operations:
                - CREATE
              selector:
                matchExpressions:
                  - key: backup
                    operator: In
                    values: ["hourly", "daily"]
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - volsync-system
                - kyverno
      generate:
        synchronize: true
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationSource
        name: "{{request.object.metadata.name}}-backup"
        namespace: "{{request.object.metadata.namespace}}"
        data:
          metadata:
            labels:
              app.kubernetes.io/managed-by: kyverno
              volsync.backup/pvc: "{{request.object.metadata.name}}"
          spec:
            sourcePVC: "{{request.object.metadata.name}}"
            trigger:
              # Use label value for schedule: hourly = every hour, daily = once per day at 2am
              schedule: "{{ request.object.metadata.labels.backup == 'hourly' && '0 * * * *' || '0 2 * * *' }}"
            restic:
              pruneIntervalDays: 7
              repository: "volsync-{{request.object.metadata.name}}"
              retain:
                hourly: 24
                daily: 7
                weekly: 4
                monthly: 2
              copyMethod: Snapshot
              storageClassName: longhorn
              volumeSnapshotClassName: longhorn-snapclass
              cacheCapacity: "2Gi"
              moverSecurityContext:
                runAsUser: 568
                runAsGroup: 568
                fsGroup: 568

    # Rule 4: Generate ReplicationDestination (restore capability)
    # IMPORTANT: Only trigger on CREATE to avoid race conditions during PVC deletion
    - name: generate-replication-destination
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              operations:
                - CREATE
              selector:
                matchExpressions:
                  - key: backup
                    operator: In
                    values: ["hourly", "daily"]
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - volsync-system
                - kyverno
      generate:
        synchronize: true
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationDestination
        name: "{{request.object.metadata.name}}-restore"
        namespace: "{{request.object.metadata.namespace}}"
        data:
          metadata:
            labels:
              app.kubernetes.io/managed-by: kyverno
              volsync.backup/pvc: "{{request.object.metadata.name}}"
          spec:
            trigger:
              manual: restore-once
            restic:
              repository: "volsync-{{request.object.metadata.name}}"
              copyMethod: Snapshot
              storageClassName: longhorn
              volumeSnapshotClassName: longhorn-snapclass
              accessModes:
                - "{{ request.object.spec.accessModes[0] || 'ReadWriteOnce' }}"
              capacity: "{{ request.object.spec.resources.requests.storage }}"
              cacheCapacity: "2Gi"
              moverSecurityContext:
                runAsUser: 568
                runAsGroup: 568
                fsGroup: 568