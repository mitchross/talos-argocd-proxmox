apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: remove-pvc-datasource
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    policies.kyverno.io/title: Remove dataSource and dataSourceRef from new PVCs
    policies.kyverno.io/description: >-
      Automatically removes spec.dataSource and spec.dataSourceRef from new PVCs to prevent
      binding issues with VolSync restore. This ensures PVCs bind immediately to fresh storage
      rather than waiting for ReplicationDestination restore jobs that may not exist.
spec:
  rules:
  - name: remove-datasource-on-create
    match:
      any:
      - resources:
          kinds:
          - PersistentVolumeClaim
    mutate:
      patchesJson6902: |-
        - op: remove
          path: /spec/dataSource
        - op: remove
          path: /spec/dataSourceRef
