apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: volsync-auto-restore
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    policies.kyverno.io/title: Auto-restore from VolSync backup if available
    policies.kyverno.io/description: >-
      For PVCs with backup labels, checks if a ReplicationDestination exists with
      backup data (latestImage). If yes, adds dataSourceRef for automatic restore.
      If no backup exists, removes dataSourceRef so PVC binds to fresh storage.
      This enables zero-touch restore when backups exist.
spec:
  rules:
    # Rule 1: If RD exists with latestImage, ensure dataSourceRef is set for restore
    - name: add-datasourceref-if-backup-exists
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              selector:
                matchLabels:
                  backup: "hourly"
      context:
        - name: rdName
          variable:
            value: "{{ request.object.metadata.name }}-restore"
        - name: rdExists
          apiCall:
            urlPath: "/apis/volsync.backube/v1alpha1/namespaces/{{ request.namespace }}/replicationdestinations/{{ rdName }}"
            jmesPath: "status.latestImage.name"
            default: ""
      preconditions:
        all:
          # Only proceed if RD exists AND has a latestImage
          - key: "{{ rdExists }}"
            operator: NotEquals
            value: ""
          - key: "{{ rdExists }}"
            operator: NotEquals
            value: "null"
      mutate:
        patchStrategicMerge:
          spec:
            dataSourceRef:
              apiGroup: volsync.backube
              kind: ReplicationDestination
              name: "{{ rdName }}"

    # Rule 2: If no backup exists, remove dataSourceRef so PVC can bind fresh
    - name: remove-datasourceref-if-no-backup
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              selector:
                matchLabels:
                  backup: "hourly"
      context:
        - name: rdName
          variable:
            value: "{{ request.object.metadata.name }}-restore"
        - name: rdExists
          apiCall:
            urlPath: "/apis/volsync.backube/v1alpha1/namespaces/{{ request.namespace }}/replicationdestinations/{{ rdName }}"
            jmesPath: "status.latestImage.name"
            default: ""
      preconditions:
        any:
          # Proceed if RD doesn't exist or has no latestImage
          - key: "{{ rdExists }}"
            operator: Equals
            value: ""
          - key: "{{ rdExists }}"
            operator: Equals
            value: "null"
      mutate:
        patchesJson6902: |-
          - op: remove
            path: /spec/dataSource
          - op: remove
            path: /spec/dataSourceRef
