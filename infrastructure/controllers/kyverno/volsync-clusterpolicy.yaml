apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-volsync-backup
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    policies.kyverno.io/title: Generate VolSync Backup Resources
    policies.kyverno.io/description: >-
      Automatically generates ReplicationSource and ReplicationDestination
      for PVCs labeled with backup=hourly or backup=daily.
      Requires namespace annotation: volsync.backube/privileged-movers: "true"
spec:
  generateExisting: true
  rules:
    # ============================================
    # HOURLY BACKUP TIER (Critical Apps)
    # ============================================

    # Rule 1: Generate ReplicationSource for hourly backups
    - name: generate-hourly-replicationsource
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              selector:
                matchLabels:
                  backup: "hourly"
      generate:
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationSource
        name: "{{request.object.metadata.name}}-backup"
        namespace: "{{request.object.metadata.namespace}}"
        synchronize: true
        data:
          spec:
            sourcePVC: "{{request.object.metadata.name}}"
            trigger:
              schedule: "0 * * * *"
            restic:
              pruneIntervalDays: 7
              repository: "{{request.object.metadata.name}}-volsync-secret"
              retain:
                hourly: 24
                daily: 7
              copyMethod: Snapshot
              volumeSnapshotClassName: longhorn
              storageClassName: longhorn
              cacheStorageClassName: longhorn

    # Rule 2: Generate ReplicationDestination for hourly backups
    - name: generate-hourly-replicationdestination
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              selector:
                matchLabels:
                  backup: "hourly"
      generate:
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationDestination
        name: "{{request.object.metadata.name}}-restore"
        namespace: "{{request.object.metadata.namespace}}"
        synchronize: true
        data:
          spec:
            trigger:
              schedule: "30 * * * *"
            restic:
              repository: "{{request.object.metadata.name}}-volsync-secret"
              copyMethod: Snapshot
              volumeSnapshotClassName: longhorn
              storageClassName: longhorn
              accessModes:
                - ReadWriteOnce
              capacity: "{{request.object.spec.resources.requests.storage}}"
              cacheStorageClassName: longhorn
              cacheCapacity: 1Gi
              moverSecurityContext:
                runAsUser: 0
                runAsGroup: 0
                fsGroup: 0

    # ============================================
    # DAILY BACKUP TIER (Non-Critical Apps)
    # ============================================

    # Rule 3: Generate ReplicationSource for daily backups
    - name: generate-daily-replicationsource
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              selector:
                matchLabels:
                  backup: "daily"
      generate:
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationSource
        name: "{{request.object.metadata.name}}-backup"
        namespace: "{{request.object.metadata.namespace}}"
        synchronize: true
        data:
          spec:
            sourcePVC: "{{request.object.metadata.name}}"
            trigger:
              schedule: "0 2 * * *"
            restic:
              pruneIntervalDays: 7
              repository: "{{request.object.metadata.name}}-volsync-secret"
              retain:
                daily: 14
              copyMethod: Snapshot
              volumeSnapshotClassName: longhorn
              storageClassName: longhorn
              cacheStorageClassName: longhorn

    # Rule 4: Generate ReplicationDestination for daily backups
    - name: generate-daily-replicationdestination
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              selector:
                matchLabels:
                  backup: "daily"
      generate:
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationDestination
        name: "{{request.object.metadata.name}}-restore"
        namespace: "{{request.object.metadata.namespace}}"
        synchronize: true
        data:
          spec:
            trigger:
              schedule: "30 2 * * *"
            restic:
              repository: "{{request.object.metadata.name}}-volsync-secret"
              copyMethod: Snapshot
              volumeSnapshotClassName: longhorn
              storageClassName: longhorn
              accessModes:
                - ReadWriteOnce
              capacity: "{{request.object.spec.resources.requests.storage}}"
              cacheStorageClassName: longhorn
              cacheCapacity: 1Gi
              moverSecurityContext:
                runAsUser: 0
                runAsGroup: 0
                fsGroup: 0
