apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: volsync-auto-restore
  annotations:
    # NOTE: No sync-wave needed - mutate policies are webhooks that intercept
    # CREATE requests, they don't run during ArgoCD sync phases
    policies.kyverno.io/title: Auto-Restore PVCs from VolSync Backups
    policies.kyverno.io/category: Backup
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: PersistentVolumeClaim
    policies.kyverno.io/description: >-
      Automatically adds dataSourceRef to PVCs labeled with backup=hourly or backup=daily
      when a ReplicationDestination exists with a latestImage snapshot. This enables
      zero-touch disaster recovery - when a PVC is deleted and recreated, it automatically
      restores from the latest backup. For new apps (no backup exists), the PVC is created
      normally without dataSourceRef.
spec:
  # This policy only applies to CREATE operations (not updates)
  background: false
  rules:
    # ============================================
    # HOURLY BACKUP TIER - Auto Restore
    # ============================================
    - name: auto-restore-hourly-backup
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              operations:
                - CREATE
              selector:
                matchLabels:
                  backup: "hourly"
      # Fetch the ReplicationDestination to check for latestImage
      # Note: default:{} handles 404 when RD doesn't exist (new app, no backup yet)
      context:
        - name: rdName
          variable:
            value: "{{request.object.metadata.name}}-restore"
        - name: latestImage
          apiCall:
            urlPath: "/apis/volsync.backube/v1alpha1/namespaces/{{request.object.metadata.namespace}}/replicationdestinations/{{request.object.metadata.name}}-restore"
            jmesPath: "status.latestImage.name || ''"
            default: {}
      # Only mutate if:
      # 1. RD exists and has latestImage (backup exists to restore from)
      # 2. PVC doesn't already have dataSourceRef
      preconditions:
        all:
          - key: "{{ latestImage }}"
            operator: NotEquals
            value: ""
          - key: "{{ request.object.spec.dataSourceRef || '' }}"
            operator: AnyIn
            value:
              - ""
              - "null"
      mutate:
        patchStrategicMerge:
          spec:
            dataSourceRef:
              apiGroup: volsync.backube
              kind: ReplicationDestination
              name: "{{ rdName }}"

    # ============================================
    # DAILY BACKUP TIER - Auto Restore
    # ============================================
    - name: auto-restore-daily-backup
      match:
        any:
          - resources:
              kinds:
                - PersistentVolumeClaim
              operations:
                - CREATE
              selector:
                matchLabels:
                  backup: "daily"
      # Note: default:{} handles 404 when RD doesn't exist (new app, no backup yet)
      context:
        - name: rdName
          variable:
            value: "{{request.object.metadata.name}}-restore"
        - name: latestImage
          apiCall:
            urlPath: "/apis/volsync.backube/v1alpha1/namespaces/{{request.object.metadata.namespace}}/replicationdestinations/{{request.object.metadata.name}}-restore"
            jmesPath: "status.latestImage.name || ''"
            default: {}
      preconditions:
        all:
          - key: "{{ latestImage }}"
            operator: NotEquals
            value: ""
          - key: "{{ request.object.spec.dataSourceRef || '' }}"
            operator: AnyIn
            value:
              - ""
              - "null"
      mutate:
        patchStrategicMerge:
          spec:
            dataSourceRef:
              apiGroup: volsync.backube
              kind: ReplicationDestination
              name: "{{ rdName }}"
