apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: volsync-smart-protection
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    policies.kyverno.io/title: VolSync Protection (Safe Mode)
    policies.kyverno.io/description: >-
      Fully automated VolSync backup/restore for PVCs labeled backup=hourly.
      
      ZERO-TOUCH WORKFLOW:
      1. Create PVC with label backup=hourly
      2. Restore job auto-triggers immediately (if S3 backup exists, restores it)
      3. Backup job starts on hourly schedule
      4. Done - completely automated!
      
      SAFETY: Restore runs FIRST (on PVC creation), backup starts on next hour.
      - If backup exists in S3 → restored automatically
      - If no backup exists → restore fails gracefully, app creates fresh data
      - Backups protect data going forward (Restic keeps retention/history)
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    # ------------------------------------------------------------------
    # RULE 1: GENERATE BACKUP JOB (Runs hourly automatically)
    # ------------------------------------------------------------------
    - name: generate-backup-job
      match:
        any:
          - resources:
              kinds: ["PersistentVolumeClaim"]
              selector:
                matchLabels:
                  backup: "hourly"
      generate:
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationSource
        name: "{{ request.object.metadata.name }}-backup"
        namespace: "{{ request.object.metadata.namespace }}"
        synchronize: true
        data:
          spec:
            sourcePVC: "{{ request.object.metadata.name }}"
            trigger:
              schedule: "0 * * * *"
            restic:
              pruneIntervalDays: 10
              repository: "s3:http://192.168.10.133:30292/volsync-backup/{{ request.object.metadata.namespace }}/{{ request.object.metadata.name }}"
              copyMethod: Direct
              storageClassName: "longhorn"
              volumeSnapshotClassName: "longhorn"
              cacheStorageClassName: "longhorn"
              cacheAccessModes: ["ReadWriteOnce"]
              cacheCapacity: "2Gi"
              retain:
                hourly: 24
                daily: 7

    # ------------------------------------------------------------------
    # RULE 2: GENERATE RESTORE JOB (Manual trigger only - prevents overwrites)
    # ------------------------------------------------------------------
    - name: generate-restore-job
      match:
        any:
          - resources:
              kinds: ["PersistentVolumeClaim"]
              selector:
                matchLabels:Auto-triggers on PVC creation)
    # ------------------------------------------------------------------
    - name: generate-restore-job
      match:
        any:
          - resources:
              kinds: ["PersistentVolumeClaim"]
              selector:
                matchLabels:
                  backup: "hourly"
      generate:
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationDestination
        name: "{{ request.object.metadata.name }}-restore"
        namespace: "{{ request.object.metadata.namespace }}"
        synchronize: true
        data:
          spec:
            trigger:
              # Auto-trigger ONCE when PVC is created (unique timestamp prevents re-runs)
              manual: "auto-restore-{{ request.object.metadata.creationTimestamp }}"
              destinationPVC: "{{ request.object.metadata.name }}"
              retain: 
                hourly: 24
                daily: 7
