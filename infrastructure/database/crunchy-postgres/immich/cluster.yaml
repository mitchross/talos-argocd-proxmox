---
apiVersion: postgres-operator.crunchydata.com/v1
kind: PostgresCluster
metadata:
  name: immich
  annotations:
    postgres-operator.crunchydata.com/autoCreateUserSchema: "true"
spec:
  # https://docs.immich.app/administration/postgres-standalone/#updating-vectorchord
  image: ghcr.io/waifulabs/crunchydata-vectorchord:ubi9-17.7-2550
  postgresVersion: 17
  databaseInitSQL:
    name: immich-postgres-init
    key: init.sql
  config:
    parameters:
      shared_preload_libraries: "vchord.so"
  monitoring:
    pgmonitor:
      exporter:
        resources:
          requests:
            cpu: 10m
            memory: 64M
          limits:
            memory: 512M
  patroni:
    dynamicConfiguration:
      synchronous_mode: false  # Disabled for single replica
      postgresql:
        max_wal_size: 5GB
        synchronous_commit: "off"  # Disabled for single replica
        parameters:
          max_connections: 500
  instances:
  - name: postgres
    replicas: 1  # Reduced from 3 for homelab
    metadata:
      labels:
        app.kubernetes.io/name: immich
    dataVolumeClaimSpec:
      storageClassName: longhorn
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 20Gi
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - topologyKey: kubernetes.io/hostname
          labelSelector:
            matchLabels:
              postgres-operator.crunchydata.com/cluster: immich
              postgres-operator.crunchydata.com/instance-set: postgres
  users:
  # Superuser
  - name: "postgres"
    databases: [ "postgres" ]
    options: "SUPERUSER"
    password:
      type: AlphaNumeric
  # Applications - using password from 1Password
  - name: "immich"
    databases: [ "immich" ]
    options: "CREATEDB CREATEROLE"
    password:
      type: AlphaNumeric
  backups:
    pgbackrest:
      configuration:
      - secret:
          name: pgo-s3-credentials
      global:
        repo1-path: /pgbackrest/immich
        repo1-s3-uri-style: path
        repo1-retention-full: "7"
        repo1-retention-full-type: count
      repos:
      - name: repo1
        s3:
          bucket: postgres-backups
          endpoint: 192.168.10.133:30293
          region: us-east-1
        schedules:
          full: "0 2 * * 0"
          differential: "0 2 * * 1-6"
