# Cilium Helm Values for Talos Proxmox Production Cluster
# Cluster Configuration
cluster:
  name: talos-proxmox-prod
  id: 1

# Kubernetes API Configuration (kubePrism via SideroLink)
k8sServiceHost: localhost
k8sServicePort: "7445"

# Kube-proxy Replacement
kubeProxyReplacement: true

# Talos-specific Security Context (required for init containers)
securityContext:
  capabilities:
    ciliumAgent:
    - CHOWN
    - KILL
    - NET_ADMIN
    - NET_RAW
    - IPC_LOCK
    - SYS_ADMIN
    - SYS_RESOURCE
    - DAC_OVERRIDE
    - FOWNER
    - SETGID
    - SETUID
    cleanCiliumState:
    - NET_ADMIN
    - SYS_ADMIN
    - SYS_RESOURCE

# Talos-specific cgroup configuration
cgroup:
  autoMount:
    enabled: false
  hostRoot: /sys/fs/cgroup

# Routing Configuration
routingMode: native
autoDirectNodeRoutes: true
ipv4NativeRoutingCIDR: 10.14.0.0/16

# IPAM Configuration
ipam:
  mode: kubernetes

# Enable Socket-level Load Balancing (critical for pod-to-service connectivity)
socketLB:
  enabled: true
  hostNamespaceOnly: false

# BPF Host Routing
bpf:
  masquerade: true

# L2 Announcements for LoadBalancer Services
l2announcements:
  enabled: true
  # Increase lease duration to reduce API calls
  leaseDuration: "15s"
  leaseRenewDeadline: "5s"
  leaseRetryPeriod: "2s"

# Increase API rate limits for L2 announcer lease management
# Formula: QPS = #services * (1 / leaseRenewDeadline)
# With 15 services: 15 * (1/5) = 3 QPS, so 20 QPS gives headroom
k8sClientRateLimit:
  qps: 20
  burst: 40

# Gateway API Support
gatewayAPI:
  enabled: true

# Hubble (Observability)
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true

# Operator Configuration
operator:
  replicas: 1
