# Garage Helm Chart Values
# Using official chart: https://git.deuxfleurs.fr/Deuxfleurs/garage

garage:
  # Replication factor - data stored on 2 nodes minimum
  replicationFactor: 2

  # Number of Garage instances to deploy
  replicaCount: 3

  # Database engine - explicit for clarity
  dbEngine: "lmdb"

  # Image configuration
  image:
    repository: dxflrs/garage
    tag: v2.1.0
    pullPolicy: IfNotPresent

  # CRITICAL: Enable Kubernetes CRD for automatic node discovery
  # This makes nodes discover each other automatically - no manual init job needed!
  kubernetesSkipCrd: false

  # Secrets - these need to be provided as strings
  # Since we can't use ArgoCD helm.parameters.valueFrom, we'll inject via environment
  rpcSecret: ""
  adminToken: ""

  # Persistence configuration using Longhorn
  persistence:
    enabled: true

    meta:
      storageClass: "longhorn"
      size: 3Gi
      accessMode: ReadWriteOnce

    data:
      storageClass: "longhorn"
      size: 30Gi
      accessMode: ReadWriteOnce

  # Service configuration
  service:
    type: ClusterIP

    # S3 API service
    s3:
      api:
        port: 3900
      web:
        port: 3902

    # Admin API service
    admin:
      port: 3903

  # S3 region name
  s3:
    region: garage

  # Resource limits
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Security context
  securityContext:
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
        - ALL

  # Pod disruption budget for high availability
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  # Environment-specific settings
  environment:
    GARAGE_ALLOW_WORLD_READABLE_SECRETS: "true"
