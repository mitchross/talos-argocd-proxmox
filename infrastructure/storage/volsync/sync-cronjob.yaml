---
# ServiceAccount for the sync CronJob
apiVersion: v1
kind: ServiceAccount
metadata:
  name: volsync-syncer
  namespace: volsync-system
---
# ClusterRole to allow patching ReplicationDestinations
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: volsync-syncer
rules:
  - apiGroups: ["volsync.backube"]
    resources: ["replicationdestinations"]
    verbs: ["get", "list", "patch"]
---
# ClusterRoleBinding to bind the role to the service account
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: volsync-syncer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: volsync-syncer
subjects:
  - kind: ServiceAccount
    name: volsync-syncer
    namespace: volsync-system
---
# CronJob that triggers ALL ReplicationDestinations to sync from S3
# Runs every 15 minutes to keep latestImage fresh for Volume Populator
# Benefits over per-RD schedule triggers:
#   - Single coordinated sync (less cluster load)
#   - 0-15 min bootstrap window (vs 30-90 min with schedule)
#   - All RDs sync together (easier debugging)
#   - Cleaner architecture
apiVersion: batch/v1
kind: CronJob
metadata:
  name: volsync-sync-destinations
  namespace: volsync-system
spec:
  schedule: "*/15 * * * *"  # Every 15 minutes for fast bootstrap
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: volsync-syncer
          restartPolicy: OnFailure
          containers:
            - name: sync
              image: bitnami/kubectl:latest
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  echo "Starting ReplicationDestination sync at $(date)"

                  # Get all ReplicationDestinations and trigger sync
                  kubectl get replicationdestination -A -o json | \
                    jq -r '.items[] | "\(.metadata.namespace) \(.metadata.name)"' | \
                    while read ns name; do
                      echo "Triggering sync for $ns/$name"
                      kubectl patch replicationdestination "$name" -n "$ns" \
                        --type merge \
                        -p "{\"spec\":{\"trigger\":{\"manual\":\"sync-$(date +%s)\"}}}" || true
                    done

                  echo "Sync trigger complete at $(date)"
