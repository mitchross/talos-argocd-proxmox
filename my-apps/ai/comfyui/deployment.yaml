apiVersion: apps/v1
kind: Deployment
metadata:
  name: comfyui
  namespace: comfyui
spec:
  strategy:
    type: Recreate
  replicas: 1
  selector:
    matchLabels:
      app: comfyui
  template:
    metadata:
      labels:
        app: comfyui
    spec:
      # Node selector for GPU nodes
      nodeSelector:
        feature.node.kubernetes.io/pci-0300_10de.present: "true"
      runtimeClassName: nvidia
      priorityClassName: gpu-workload-preemptible
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      - key: "gpu"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      initContainers:
      - name: git-config
        image: alpine/git
        command: [ "sh", "-c", "git config --global core.fileMode false || true" ]
        volumeMounts:
        - name: comfyui-storage
          mountPath: /root
      - name: install-prompt-manager
        image: alpine/git
        command:
        - sh
        - -c
        - |
          DEST="/root/ComfyUI/custom_nodes/ComfyUI-Prompt-Manager"
          if [ -d "$DEST/.git" ]; then
            cd "$DEST" && git pull --ff-only || true
          elif [ -d "$DEST" ]; then
            echo "Already installed (non-git), skipping"
          elif [ -d "/root/ComfyUI/custom_nodes" ]; then
            git clone https://github.com/FranckyB/ComfyUI-Prompt-Manager.git "$DEST"
          else
            echo "ComfyUI not yet initialized, skipping (will be cloned on next restart)"
          fi
        volumeMounts:
        - name: comfyui-storage
          mountPath: /root
      - name: install-wan-video-wrapper
        image: alpine/git
        command:
        - sh
        - -c
        - |
          DEST="/root/ComfyUI/custom_nodes/ComfyUI-WanVideoWrapper"
          if [ -d "$DEST/.git" ]; then
            cd "$DEST" && git pull --ff-only || true
          elif [ -d "$DEST" ]; then
            echo "Already installed (non-git), skipping"
          elif [ -d "/root/ComfyUI/custom_nodes" ]; then
            git clone https://github.com/kijai/ComfyUI-WanVideoWrapper.git "$DEST"
          else
            echo "ComfyUI not yet initialized, skipping"
          fi
        volumeMounts:
        - name: comfyui-storage
          mountPath: /root
      - name: install-comfyui-gallery
        image: alpine/git
        command:
        - sh
        - -c
        - |
          DEST="/root/ComfyUI/custom_nodes/ComfyUI-Gallery"
          if [ -d "$DEST/.git" ]; then
            cd "$DEST" && git pull --ff-only || true
          elif [ -d "$DEST" ]; then
            echo "Already installed (non-git), skipping"
          elif [ -d "/root/ComfyUI/custom_nodes" ]; then
            git clone https://github.com/PanicTitan/ComfyUI-Gallery.git "$DEST"
          else
            echo "ComfyUI not yet initialized, skipping"
          fi
        volumeMounts:
        - name: comfyui-storage
          mountPath: /root
      - name: copy-example-workflows
        image: alpine
        command:
        - sh
        - -c
        - |
          DEST="/root/ComfyUI/user/default/workflows"
          mkdir -p "$DEST"
          # Copy Wan 2.2 example workflows from wrapper
          SRC="/root/ComfyUI/custom_nodes/ComfyUI-WanVideoWrapper/example_workflows"
          if [ -d "$SRC" ]; then
            cp -f "$SRC"/*.json "$DEST/" 2>/dev/null && \
              echo "Copied Wan 2.2 example workflows" || true
          fi
        volumeMounts:
        - name: comfyui-storage
          mountPath: /root
      containers:
      - name: comfyui
        # Image from https://github.com/YanWenKun/ComfyUI-Docker/tree/main/cu128-megapak-pt29
        # renovate: datasource=docker depName=yanwk/comfyui-boot
        image: yanwk/comfyui-boot:cu128-megapak-pt29@sha256:778d8bd9d8e5ccf7ae4b8a6841f2ec484616d51c0c55ff473dffcbe817da3aee
        imagePullPolicy: IfNotPresent
        workingDir: /root
        ports:
        - containerPort: 8188
        env:
        - name: CLI_ARGS
          value: "--use-sage-attention --listen 0.0.0.0 --port 8188"
        # RTX 3090 = Ampere architecture = compute capability 8.6
        - name: TORCH_CUDA_ARCH_LIST
          value: "8.6"
        # CMAKE build options for CUDA extensions
        - name: CMAKE_ARGS
          value: "-DBUILD_opencv_world=ON -DWITH_CUDA=ON -DCUDA_FAST_MATH=ON -DWITH_CUBLAS=ON"
        - name: HF_TOKEN
          valueFrom:
            secretKeyRef:
              name: comfyui-secrets
              key: HF_TOKEN
        resources:
          requests:
            memory: "8Gi"
            cpu: "2"
            nvidia.com/gpu: "1"
          limits:
            memory: "80Gi"
            cpu: "16"
            nvidia.com/gpu: "1"
        volumeMounts:
        # Single storage volume at /root - container handles internal structure
        - name: comfyui-storage
          mountPath: /root
        # ComfyUI Manager config with security_level = normal
        - name: manager-config
          mountPath: /root/ComfyUI/user/__manager/config.ini
          subPath: config.ini
        readinessProbe:
          httpGet:
            path: /
            port: 8188
          initialDelaySeconds: 300 # Increased for large downloads on first start
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 6
        livenessProbe:
          httpGet:
            path: /
            port: 8188
          initialDelaySeconds: 1500 # Increased for large downloads on first start
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
      volumes:
      - name: comfyui-storage
        persistentVolumeClaim:
          claimName: comfyui-storage
      - name: manager-config
        configMap:
          name: comfyui-manager-config
