apiVersion: batch/v1
kind: Job
metadata:
  name: load-har-analyzer-v4
  namespace: open-webui
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: loader
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for Open-WebUI to be ready..."
          sleep 30

          API="http://open-webui.open-webui.svc.cluster.local:8080/api/v1"
          FUNC_CODE=$(cat /functions/har-analyzer-function.py | jq -Rs .)

          if [ -z "$ADMIN_TOKEN" ]; then
            echo "ADMIN_TOKEN not set — skipping auto-load."
            echo "Import manually: Workspace > Functions > Add Function > paste code"
            exit 0
          fi

          AUTH="Authorization: Bearer $ADMIN_TOKEN"
          CT="Content-Type: application/json"

          PAYLOAD="{
            \"id\": \"har_forensics_analyzer\",
            \"name\": \"HAR Forensics Analyzer\",
            \"type\": \"filter\",
            \"content\": $FUNC_CODE,
            \"meta\": {
              \"description\": \"Filter: preprocesses uploaded .har files into forensic reports for LLM analysis\"
            },
            \"is_active\": true,
            \"is_global\": true
          }"

          # Try update first, then create
          echo "Attempting to update existing function..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "$API/functions/id/har_forensics_analyzer/update" \
            -H "$AUTH" -H "$CT" -d "$PAYLOAD")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Function updated successfully!"
          else
            echo "Update returned $HTTP_CODE, trying create..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "$API/functions/create" \
              -H "$AUTH" -H "$CT" -d "$PAYLOAD")

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
              echo "Function created successfully!"
            else
              echo "Create returned $HTTP_CODE — may need manual import."
              echo "Workspace > Functions > Add > paste code from har-analyzer-function.py"
            fi
          fi

          # Enable as global filter
          echo "Enabling as global filter..."
          curl -s -X POST "$API/functions/id/har_forensics_analyzer/toggle/global" \
            -H "$AUTH" -H "$CT" || true

          echo "Done!"
        env:
        - name: ADMIN_TOKEN
          valueFrom:
            secretKeyRef:
              name: open-webui-admin-token
              key: token
              optional: true
        volumeMounts:
        - name: functions
          mountPath: /functions
      volumes:
      - name: functions
        configMap:
          name: har-analyzer-function
