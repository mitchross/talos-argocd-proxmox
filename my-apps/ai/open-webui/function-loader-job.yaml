apiVersion: batch/v1
kind: Job
metadata:
  name: load-har-analyzer-v5
  namespace: open-webui
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      runtimeClassName: nvidia
      nodeSelector:
        feature.node.kubernetes.io/pci-0300_10de.present: "true"
      tolerations:
      - key: "gpu"
        operator: "Equal"
        value: "true"
        effect: "NoSchedule"
      containers:
      - name: loader
        image: ghcr.io/open-webui/open-webui:cuda@sha256:2c3b15ca8128d65e6c2f3f57a436b0973784f6445e537f23c7cbb47061e1c3ad
        command:
        - python3
        - -c
        - |
          import sys
          sys.path.insert(0, "/app/backend")
          import os
          os.environ.setdefault("DATA_DIR", "/app/backend/data")

          with open("/functions/har-analyzer-function.py") as f:
              code = f.read()

          from open_webui.models.functions import Functions, FunctionForm, FunctionMeta
          from open_webui.models.users import Users

          # Find first admin user
          users_data = Users.get_users()
          admin_id = None
          if isinstance(users_data, dict) and "users" in users_data:
              for u in users_data["users"]:
                  if u.role == "admin":
                      admin_id = u.id
                      break

          if not admin_id:
              print("WARNING: No admin user found, using placeholder ID")
              admin_id = "system"

          form = FunctionForm(
              id="har_forensics_analyzer",
              name="HAR Forensics Analyzer",
              type="filter",
              content=code,
              meta=FunctionMeta(
                  description="Filter: preprocesses uploaded .har files into forensic reports for LLM analysis"
              )
          )

          existing = Functions.get_function_by_id("har_forensics_analyzer")
          if existing:
              result = Functions.update_function_by_id("har_forensics_analyzer", {
                  "name": "HAR Forensics Analyzer",
                  "type": "filter",
                  "content": code,
                  "meta": {"description": "Filter: preprocesses uploaded .har files into forensic reports for LLM analysis"},
                  "is_active": True,
                  "is_global": True,
              })
              print(f"Updated function: {result.id}")
          else:
              result = Functions.insert_new_function(admin_id, "filter", form)
              if result:
                  Functions.update_function_by_id("har_forensics_analyzer", {
                      "is_active": True,
                      "is_global": True,
                  })
                  print(f"Created function: {result.id}")
              else:
                  print("ERROR: Failed to create function")
                  sys.exit(1)

          print(f"Active: {result.is_active}, Global: {result.is_global}")
          print("Done!")
        envFrom:
        - configMapRef:
            name: open-webui-configmap
        volumeMounts:
        - name: functions
          mountPath: /functions
        - name: data
          mountPath: /app/backend/data
      volumes:
      - name: functions
        configMap:
          name: har-analyzer-function
      - name: data
        persistentVolumeClaim:
          claimName: storage
