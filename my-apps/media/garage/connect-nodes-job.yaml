---
apiVersion: batch/v1
kind: Job
metadata:
  name: garage-connect-nodes
  namespace: garage
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: garage
      containers:
        - name: connect-nodes
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Waiting for all garage pods to be ready..."
              kubectl wait --for=condition=ready pod -l app=garage -n garage --timeout=120s
              
              echo "Getting node IDs from all pods..."
              NODE_0=$(kubectl exec -n garage garage-0 -- /garage status 2>&1 | grep garage-0 | awk '{print $1}')
              NODE_1=$(kubectl exec -n garage garage-1 -- /garage status 2>&1 | grep garage-1 | awk '{print $1}')
              NODE_2=$(kubectl exec -n garage garage-2 -- /garage status 2>&1 | grep garage-2 | awk '{print $1}')
              
              echo "Node IDs:"
              echo "  garage-0: $NODE_0"
              echo "  garage-1: $NODE_1"
              echo "  garage-2: $NODE_2"
              
              echo "Configuring cluster layout..."
              kubectl exec -n garage garage-0 -- /garage layout assign -z dc1 -c 100G $NODE_0
              kubectl exec -n garage garage-0 -- /garage layout assign -z dc1 -c 100G $NODE_1
              kubectl exec -n garage garage-0 -- /garage layout assign -z dc1 -c 100G $NODE_2
              
              echo "Applying layout (version 1)..."
              kubectl exec -n garage garage-0 -- /garage layout apply --version 1
              
              echo "Cluster configured successfully!"
              kubectl exec -n garage garage-0 -- /garage status
