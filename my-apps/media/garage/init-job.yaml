---
apiVersion: batch/v1
kind: Job
metadata:
  name: garage-init
  namespace: garage
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: garage
      containers:
        - name: init-cluster
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Waiting for Garage nodes to be ready..."
              sleep 30
              
              # Get node status from garage-0 pod
              echo "Checking cluster status..."
              kubectl exec -n garage garage-0 -- /garage status || true
              
              # Get list of nodes without roles
              NODES=$(kubectl exec -n garage garage-0 -- /garage status 2>&1 | grep "NO ROLE" | awk '{print $1}' || true)
              
              if [ -z "$NODES" ]; then
                echo "All nodes already have roles assigned"
                kubectl exec -n garage garage-0 -- /garage status
                exit 0
              fi
              
              echo "Found unassigned nodes: $NODES"
              echo "Configuring layout..."
              
              # Assign capacity to each node (100GB each)
              for NODE_ID in $NODES; do
                echo "Assigning capacity to node $NODE_ID"
                kubectl exec -n garage garage-0 -- /garage layout assign $NODE_ID -z dc1 -c 100G
              done
              
              # Apply the layout
              echo "Applying layout configuration..."
              kubectl exec -n garage garage-0 -- /garage layout apply --version 1
              
              echo "Garage cluster initialized successfully!"
              kubectl exec -n garage garage-0 -- /garage status
